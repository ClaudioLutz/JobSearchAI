<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Job Matches - JobSearchAI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('index') }}">
                        <i class="bi bi-house"></i> Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    All Job Matches
                </li>
            </ol>
        </nav>
        
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-table"></i> All Job Matches</h1>
                <p class="lead text-muted">Unified database of all job matches across search terms and CV versions</p>
            </div>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel">
            <h2>Filters</h2>
            <form id="filter-form" method="GET" action="{{ url_for('job_matching.view_all_matches') }}">
                <div class="filter-row">
                    <div class="filter-field">
                        <label for="search_term">Search Term:</label>
                        <select id="search_term" name="search_term">
                            <option value="">All Search Terms</option>
                            {% for term in available_search_terms %}
                            <option value="{{ term }}" {% if filters.search_term == term %}selected{% endif %}>
                                {{ term }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-field">
                        <label for="cv_key">CV Version:</label>
                        <select id="cv_key" name="cv_key">
                            <option value="">All CV Versions</option>
                            {% for cv in available_cvs %}
                            <option value="{{ cv.cv_key }}" {% if filters.cv_key == cv.cv_key %}selected{% endif %}>
                                {{ cv.file_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-field">
                        <label for="min_score">Min Score:</label>
                        <input type="number" id="min_score" name="min_score" 
                               min="0" max="10" step="1" 
                               value="{{ filters.min_score }}" 
                               placeholder="0-10">
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-field">
                        <label for="location">Location:</label>
                        <input type="text" id="location" name="location" 
                               value="{{ filters.location }}" 
                               placeholder="e.g., Zürich">
                    </div>

                    <div class="filter-field">
                        <label for="date_from">From Date:</label>
                        <input type="date" id="date_from" name="date_from" 
                               value="{{ filters.date_from }}">
                    </div>

                    <div class="filter-field">
                        <label for="date_to">To Date:</label>
                        <input type="date" id="date_to" name="date_to" 
                               value="{{ filters.date_to }}">
                    </div>

                    <div class="filter-field">
                        <label for="sort_by">Sort By:</label>
                        <select id="sort_by" name="sort_by">
                            <option value="overall_match DESC" {% if filters.sort_by == 'overall_match DESC' %}selected{% endif %}>
                                Score (High to Low)
                            </option>
                            <option value="overall_match ASC" {% if filters.sort_by == 'overall_match ASC' %}selected{% endif %}>
                                Score (Low to High)
                            </option>
                            <option value="matched_at DESC" {% if filters.sort_by == 'matched_at DESC' %}selected{% endif %}>
                                Date (Newest First)
                            </option>
                            <option value="matched_at ASC" {% if filters.sort_by == 'matched_at ASC' %}selected{% endif %}>
                                Date (Oldest First)
                            </option>
                            <option value="company_name ASC" {% if filters.sort_by == 'company_name ASC' %}selected{% endif %}>
                                Company Name (A-Z)
                            </option>
                            <option value="job_title ASC" {% if filters.sort_by == 'job_title ASC' %}selected{% endif %}>
                                Job Title (A-Z)
                            </option>
                        </select>
                    </div>
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <button type="button" class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                </div>
            </form>
        </div>

        <!-- Results Summary -->
        <div class="results-summary">
            <p>Showing {{ results|length }} of {{ total_count }} matches (Page {{ current_page }} of {{ total_pages }})</p>
            <div class="bulk-actions">
                <button id="btn-select-all" class="btn btn-secondary" onclick="selectAll()">Select All</button>
                <button id="btn-deselect-all" class="btn btn-secondary" onclick="deselectAll()">Deselect All</button>
                <button id="btn-generate-letters" class="btn btn-primary" onclick="generateLetters()" disabled>
                    Generate Letters for Selected (0)
                </button>
            </div>
        </div>

        <!-- Results Table -->
        {% if results %}
        <div class="results-table-container">
            <table class="results-table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="select-all-header" onchange="toggleAllCheckboxes()">
                        </th>
                        <th>Job Title</th>
                        <th>Company</th>
                        <th>Location</th>
                        <th>Score</th>
                        <th>Search Term</th>
                        <th>Date Matched</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match in results %}
                    <tr {% if match.has_motivation_letter %}class="table-info"{% endif %}>
                        <td>
                            <input type="checkbox" class="job-checkbox" value="{{ match.job_url }}" onchange="updateBulkActions()">
                        </td>
                        <td>
                            <a href="{{ match.job_url }}" target="_blank" rel="noopener noreferrer">
                                {{ match.job_title or 'N/A' }}
                            </a>
                            {% if match.has_motivation_letter %}
                                <i class="bi bi-envelope-check-fill text-success ms-1" 
                                   title="Letter generated" 
                                   style="font-size: 0.9em;"></i>
                            {% endif %}
                        </td>
                        <td>{{ match.company_name or 'N/A' }}</td>
                        <td>{{ match.location or 'N/A' }}</td>
                        <td>
                            <span class="score-badge score-{{ match.score_class }}">
                                {{ match.overall_match }}/10
                            </span>
                        </td>
                        <td>
                            <span class="search-term-badge">{{ match.search_term }}</span>
                        </td>
                        <td>{{ match.matched_at[:10] if match.matched_at else 'N/A' }}</td>
                        <td>
                            <!-- Actions Dropdown -->
                            <div class="dropdown">
                                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" 
                                        id="actionsDropdown{{ loop.index }}" 
                                        data-bs-toggle="dropdown" 
                                        aria-expanded="false">
                                    Actions
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="actionsDropdown{{ loop.index }}">
                                    <!-- View Actions -->
                                    <li><a class="dropdown-item" href="#" 
                                           onclick="viewReasoning('{{ match.job_url }}'); return false;">
                                        <i class="bi bi-eye"></i> View Reasoning
                                    </a></li>
                                    <li><a class="dropdown-item" href="{{ match.job_url }}" 
                                           target="_blank" rel="noopener noreferrer">
                                        <i class="bi bi-box-arrow-up-right"></i> View Job Ad
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    
                                    <!-- Generation Actions -->
                                    <li><a class="dropdown-item" href="#" 
                                           onclick="generateLetter('{{ match.job_url }}', 'Lebenslauf_-_Lutz_Claudio'); return false;">
                                        <i class="bi bi-file-earmark-text"></i> Generate Letter
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" 
                                           onclick="generateLetterManual('{{ match.job_url }}', 'Lebenslauf_-_Lutz_Claudio'); return false;">
                                        <i class="bi bi-pencil-square"></i> Generate Letter (Manual Text)
                                    </a></li>
                                    
                                    <!-- Document Actions (conditional) -->
                                    {% if match.has_docx %}
                                    <li><a class="dropdown-item" href="{{ url_for('motivation_letter.download_motivation_letter_docx', file_path=match.motivation_letter_docx_path) }}">
                                        <i class="bi bi-file-word"></i> Download Word
                                    </a></li>
                                    {% endif %}
                                    
                                    {% if match.has_scraped_data %}
                                    <li><a class="dropdown-item" href="{{ url_for('motivation_letter.view_scraped_data', scraped_data_filename=match.scraped_data_filename) }}">
                                        <i class="bi bi-file-code"></i> View Scraped Data
                                    </a></li>
                                    {% endif %}
                                    
                                    {% if match.has_email_text %}
                                    <li><a class="dropdown-item" href="{{ url_for('motivation_letter.view_email_text', json_path=match.motivation_letter_json_path) }}">
                                        <i class="bi bi-envelope"></i> View Email Text
                                    </a></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
            {% if current_page > 1 %}
            <a href="?{% for key, value in filters.items() %}{% if value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ current_page - 1 }}" 
               class="btn btn-secondary">← Previous</a>
            {% else %}
            <button class="btn btn-secondary" disabled>← Previous</button>
            {% endif %}

            <span class="page-info">Page {{ current_page }} of {{ total_pages }}</span>

            {% if current_page < total_pages %}
            <a href="?{% for key, value in filters.items() %}{% if value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ current_page + 1 }}" 
               class="btn btn-secondary">Next →</a>
            {% else %}
            <button class="btn btn-secondary" disabled>Next →</button>
            {% endif %}
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <h3>Export Options</h3>
            <button class="btn btn-secondary" onclick="exportToCSV()">Export to CSV</button>
            <button class="btn btn-secondary" onclick="exportToMarkdown()">Export to Markdown</button>
        </div>
        {% else %}
        <div class="no-results">
            <p>No job matches found. Try adjusting your filters.</p>
        </div>
        {% endif %}
    </div>

    <!-- View Reasoning Modal -->
    <div class="modal fade" id="reasoningModal" tabindex="-1" aria-labelledby="reasoningModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reasoningModalLabel">Match Reasoning</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 id="reasoning-job-title" class="mb-3"></h6>
                    <div id="reasoning-content" style="white-space: pre-wrap;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Text Input Modal -->
    <div class="modal fade" id="manualTextModal" tabindex="-1" aria-labelledby="manualTextModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manualTextModalLabel">Manual Job Text Input</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Paste the full job description text below. The system will attempt to structure this text and then generate the motivation letter.</p>
                    <div class="mb-3">
                        <label for="manualJobUrl" class="form-label">Job URL:</label>
                        <input type="text" class="form-control" id="manualJobUrl" readonly>
                    </div>
                    <input type="hidden" id="manualCvFilename">
                    <div class="mb-3">
                        <label for="manualJobTextInput" class="form-label">Job Announcement Text:</label>
                        <textarea class="form-control" id="manualJobTextInput" rows="15" placeholder="Paste the job description here..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitManualTextBtn">Generate from Text</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/all_matches.js') }}"></script>
</body>
</html>
